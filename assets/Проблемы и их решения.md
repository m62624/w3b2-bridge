Нужно сделать всю логику взаимодействия с пользователем прозрачной и полностью на блокчейне, чтобы даже запросы на финансирование и ответы сервиса были публичными транзакциями. Ставим максимальную прозрачность и доверие.


* Запрос на пополнение (от пользователя): Пользователь, у которого уже есть небольшой начальный баланс (оплаченный сервисом вне блокчейна), отправляет транзакцию, вызывающую новую инструкцию request_funding. Эта инструкция создает PDA-запись (например, FundingRequest), которая будет служить публичным запросом.

* Обработка запроса (от сервиса): оффчейн-сервис постоянно "слушает" блокчейн, ищет события RequestForFunding. Когда он находит такой запрос, он выполняет свою бизнес-логику. Если он одобряет запрос, он отправляет транзакцию, вызывающую новую инструкцию approve_funding.

Перевод средств (программой): Инструкция approve_funding проверяет, что ее вызывает администратор, инициирует перевод SOL с админского PDA на кошелек пользователя с помощью invoke_signed, и обновляет статус PDA-запроса на "одобрено".


---

События (для всех): Смарт-контракт будет генерировать события, как для запроса (RequestForFunding), так и для его одобрения (FundingApproved) или отклонения.


## Работа с PDA и статусами в W3B2 смарт-контракте

### 1️⃣ PDA — это **не программа**, а **аккаунт с данными**, управляемый программой

* Программа (смарт-контракт) **не хранит состояние сама**, она использует PDA для этого.
* PDA — это **учётная запись на блокчейне**, у которой есть:

  * owner (программа, которая может изменять данные)
  * данные (`AdminAccount`, `FundingRequest`, `UserPda` и т.д.)
  * lamports (баланс SOL)

---

### 2️⃣ Когда создавать PDA

* **Обычно один раз на конкретный объект**, чтобы хранить состояние:

  * `UserPda` → **один на пользователя**, создаётся через `register_user`.
  * `AdminAccount` → **один на администратора**, создаётся через `register_admin`.
  * `FundingRequest` → **один на каждый запрос финансирования**, создаётся через `request_funding`.

> Для каждого нового запроса нужен отдельный PDA, иначе данные предыдущего запроса перезапишутся.

---

### 3️⃣ Админский PDA (`AdminAccount`)

* **Создаётся один раз на администратора** через `register_admin`.
* **Хранит**:

  * `owner: [u8;32]` — публичный ключ админа
* **Используется**:

  * Для проверки подписи при `approve_funding`
  * Для генерации `invoke_signed` при переводе средств

---

### 4️⃣ PDA запроса на финансирование (`FundingRequest`)

* **Создаётся один раз на каждый запрос пользователя** через `request_funding`.

* **Структура:**

```rust
pub struct FundingRequest {
    pub user_wallet: Pubkey,       // кошелек пользователя
    pub amount: u64,               // сумма запроса
    pub status: u8,                // Pending / Approved / Rejected
    pub target_admin: [u8; 32],    // публичный ключ админа, к которому обращаемся
}
```

* **Жизненный цикл**:

  1. Пользователь вызывает `request_funding(amount, target_admin)`
  2. Создаётся **новый PDA**, заполняются поля:

     * `user_wallet` = кошелек пользователя
     * `amount` = сумма запроса
     * `status` = `Pending`
     * `target_admin` = публичный ключ админа
  3. Генерируется событие `FundingRequested`, оффчейн-сервис видит его и решает одобрять или отклонять
  4. Админ вызывает `approve_funding` или `reject_funding`:

     * проверка `Pending` + совпадение `target_admin`
     * перевод средств (для `approve`)
     * изменение `status` на `Approved` или `Rejected`
  5. PDA **не создаётся заново**, это та же запись на цепочке

---

### 5️⃣ Пользовательский PDA (`UserPda`)

* **Создаётся один раз на пользователя** через `register_user`.
* **Хранит**:

  * `profile: UserAccount` — базовые данные пользователя
  * `linked_wallet: Option<[u8;32]>` — дополнительные кошельки
  * `created_at: u64` — timestamp регистрации
* **Используется**:

  * Для `dispatch_command` и других пользовательских операций
  * Проверка подписи: владелец или связанный кошелек

---

### 6️⃣ Статусы и зачем они нужны

* `Pending` → запрос создан, ждёт одобрения
* `Approved` → админ перевёл средства
* `Rejected` → админ отклонил
* **Почему нужны**: блокчейн хранит только текущее состояние PDA, а не историю действий. Статус нужен, чтобы **не повторять действия** (например, нельзя дважды одобрить один запрос)

---

### 7️⃣ Полный цикл запроса

1. Пользователь:

```rust
request_funding(amount, target_admin)
```

→ создаётся `FundingRequest PDA` с `Pending`

2. Сервис/админ:

```rust
approve_funding()
```

→ проверка `Pending` + совпадение `target_admin` → перевод средств → `status = Approved`

3. Все слушатели сети видят события `FundingRequested` и `FundingApproved`

4. PDA хранит только **актуальное состояние**: сумма, статус, целевой админ

---

### 8️⃣ Вывод

* **Каждый запрос = отдельный PDA**
* **Статус = часть PDA**, нужен для проверки повторного выполнения
* **target\_admin = часть PDA**, нужен для того, чтобы знать, кто может обработать запрос
* **Параметры функций** нужны только для **инициализации PDA** (`request_funding`). После этого все операции используют **данные из PDA**
