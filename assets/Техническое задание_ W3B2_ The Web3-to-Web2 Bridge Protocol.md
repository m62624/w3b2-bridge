# **W3B2: Web3-to-Web2 Bridge (Anchor Program)**

**Протокол, обеспечивающий безопасный обмен командами и финансами между пользователями Web3 и сервисами Web2.**

Особенность: оффчейн сервис полностью изолирован от публичного интернета. Сетевой доступ активируется только по событиям из блокчейна.

---

## 1. Компоненты системы

| Компонент                                  | Назначение                                                                                                                                                                |
| ------------------------------------------ | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Anchor Program (`w3b2-bridge-program`)** | Смарт-контракт на Solana. Валидирует транзакции, хранит состояния FundingRequest и AdminAccount, проверяет подписи через PDA, генерирует события для off-chain слушателя. |
| **Оффчейн сервисы**                        | Оффчейн слушатель блокчейна. Получает события смарт-контракта (RequestForFunding, FundingApproved), верифицирует подписи и выполняет бизнес-логику сервиса.               |
| **User Wallet / Admin Wallet**             | Подписывают транзакции. Пользователь инициирует запрос финансирования, администратор его одобряет.                                                                        |

---

## 2. Структура смарт-контракта

### 2.1 Accounts (Anchor PDA)

| Account          | PDA / Signer                                   | Описание                                                         |
| ---------------- | ---------------------------------------------- | ---------------------------------------------------------------- |
| `AdminAccount`   | `[b"admin", authority.key()]`                  | Хранит владельца, баланс и права администратора.                 |
| `FundingRequest` | `[b"funding", user_wallet.key(), payer.key()]` | Хранит статус финансирования: `Pending`, `Approved`, `Rejected`. |

---

### 2.2 Инструкции

| Instruction        | Context           | Логика                                                                                                                                                                                                                                                |
| ------------------ | ----------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `register_admin`   | `RegisterAdmin`   | Создаёт PDA админа, переводит начальный баланс из кошелька плательщика, проверяет минимальный баланс для аренды (rent).                                                                                                                               |
| `request_funding`  | `RequestFunding`  | Создаёт PDA FundingRequest с `Pending` статусом. Генерирует событие `FundingRequested`.                                                                                                                                                               |
| `approve_funding`  | `ApproveFunding`  | Проверяет, что транзакцию подписал авторизованный админ. Проверяет баланс PDA и статус запроса. Переводит SOL с PDA на кошелек пользователя (`sub_lamports` / `add_lamports`) и обновляет статус на `Approved`. Генерирует событие `FundingApproved`. |
| `dispatch_command` | `DispatchCommand` | Универсальная инструкция для передачи зашифрованного payload. Проверяет длину, проверяет подпись отправителя (user wallet), генерирует событие `CommandEvent`.                                                                                        |

---

### 2.3 Основная логика

* **Запрос на пополнение (request\_funding)**
  Пользователь отправляет транзакцию с новой инструкцией `request_funding`. Создаётся PDA `FundingRequest` с публичным статусом.

* **Обработка запроса (approve\_funding)**
  Off-chain сервер слушает события `FundingRequested`. После проверки бизнес-логики, сервер инициирует транзакцию `approve_funding`, которая:

  1. Проверяет, что вызвал администратор.
  2. Проверяет статус FundingRequest (`Pending`).
  3. Проверяет баланс AdminAccount.
  4. Переводит SOL с PDA админа на кошелёк пользователя.
  5. Обновляет статус FundingRequest на `Approved`.
  6. Генерирует событие `FundingApproved`.

* **Команды сервиса (dispatch\_command)**
  Off-chain сервис слушает события `CommandEvent` для выполнения зашифрованных команд. Payload может содержать Borsh-структуру `CommandConfig`.

---

### 2.4 События (Anchor Events)

| Event              | Когда генерируется                                                                                  |
| ------------------ | --------------------------------------------------------------------------------------------------- |
| `FundingRequested` | После `request_funding`. Включает кошелёк пользователя, сумму, администратора, timestamp.           |
| `FundingApproved`  | После `approve_funding`. Включает кошелёк пользователя, сумму, администратора, timestamp.           |
| `CommandEvent`     | После `dispatch_command`. Включает отправителя, администратора, команду, режим, payload, timestamp. |

---

### 2.5 Безопасность

* Администратор и пользователь проверяются через PDA и подписи.
* Статусы FundingRequest защищают от двойного одобрения.
* Баланс PDA контролирует, чтобы не было перерасхода.
* Все действия логируются через события для off-chain слушателя.

---

Двухфазная синхронизация:
┌─────────────┐
│ DB (slot N) │
└──────┬──────┘
       │
       ▼
 [catch-up worker] ← исторические блоки N..M
       │
       └──► обновляет DB (slot M)
       │
       ▼
 [live-sync worker] ← подписка через WS
       │
       └──► пишет события + slot в DB
