### **W3B2: The Web3-to-Web2 Bridge Protocol**

**W3B2: Протокол, который обеспечивает безопасность и верификацию Web3 с гибкостью и производительностью Web2.**

Ключевая особенность: Сервис-брокер полностью изолирован от публичного интернета. Он активирует сетевой доступ к конкретному клиенту только на основе команды из блокчейна, что делает его неуязвимым для внешних атак.

-----

### 1\. Компоненты системы

  * **Solana Program (Смарт-контракт): `w3b2-bridge-program`**
    Брокер и валидатор сообщений. Его основная задача — принимать команды от клиентов и сервисов, проверять их подлинность (используя PDA и подписи) и служить единственным источником правды для всех сторон. Программа регистрирует намерение и подтверждает, что оно исходит от авторизованного пользователя.

  * **Сервер (Server API):**
    Сервис-хранилище, которое обеспечивает доступ к базе данных. **Не имеет прямого доступа в интернет** и не слушает входящие соединения.

  * **Серверный мост (Server Bridge): `w3b2-bridge-listener`**
    Слушает блокчейн на наличие новых команд. **Расшифровывает** их и передает в Server API. Отвечает за **управление сетевыми соединениями** и их установку.

  * **Клиент (Client): `w3b2-client`**
    Пользовательская программа, которая генерирует ключи, отправляет зашифрованные команды и устанавливает HTTP-соединение. Состоит из двух частей:

      * **Клиентский мост (Client Bridge):** Отвечает за взаимодействие с блокчейном.
      * **Клиентская логика:** Отвечает за взаимодействие с пользователем и его локальной БД.

  * **Клиент администратора (Admin Client):**
    Программа с уникальным ключом для управления доступом и привилегированными операциями.

-----

### 2\. API Программы Solana (Инструкции)

Протокол использует одну универсальную инструкцию `dispatch_command`, которая принимает `u64`-идентификатор команды и зашифрованную полезную нагрузку. Вся логика работы с данными реализована off-chain.

| Название               | `u64` ID | Входящие данные                                                   | Описание                                                                                             |
| :--------------------- | :------- | :---------------------------------------------------------------- | :--------------------------------------------------------------------------------------------------- |
| `RegisterUser`         | `1`      | `pub_client`: публичный ключ клиента                              | Регистрирует пользователя. Сервис отвечает своим `pub_service` для шифрования.                       |
| `RequestConnection`    | `3`      | `config`: зашифрованная структура `CommandConfig`                 | Клиент запрашивает установку соединения, отправляя зашифрованный `IP` или `URL` и `сессионный ключ`. |
| `CRUD_Create`          | `5`      | `config`: зашифрованный `IP` или `URL`, `data_hash`, `time_limit` | Создаёт новую запись. Сервис ожидает данные по HTTP в течение `time_limit`.                          |
| `CRUD_Read`            | `7`      | `config`: зашифрованный `IP` или `URL`, `data_id`                 | Читает данные. Сервис открывает соединение для передачи данных клиенту.                              |
| `CRUD_Update`          | `9`      | `config`: зашифрованный `IP` или `URL`, `data_id`, `time_limit`   | Обновляет существующую запись. Сервис ждёт обновления данных по HTTP.                                |
| `CRUD_Delete`          | `11`     | `config`: зашифрованный `IP` или `URL`, `data_id`                 | Удаляет данные.                                                                                      |
| `StartSession`         | `13`     | `config`: зашифрованный `IP` или `URL`                            | Устанавливает соединение для нескольких команд (для чтения или изменения).                           |
| `EndSession`           | `15`     |                                                                   | Закрывает открытую сессию.                                                                           |
| `Admin_Authorize`      | `17`     | `admin_pub_key`: публичный ключ администратора                    | Регистрирует ключ администратора для привилегированных операций.                                     |
| `Admin_Access_Control` | `19`     | `config`: зашифрованные `admin_action`, `user_id`                 | Предоставляет администратору доступ к данным.                                                        |
| `Generic_Command`      | `21`     | `config`: зашифрованные произвольные данные                       | Универсальная команда, которая может быть использована для любых расширений протокола.               |

-----

### 3\. Процесс Работы

1.  **Регистрация:** Клиентский мост генерирует ключи, отправляет свой публичный ключ в блокчейн. Серверный мост отвечает своим публичным ключом.
2.  **Запрос:** Клиентский мост шифрует **структуру `CommandConfig`** (включая `command_id` и `сессионный ключ`) публичным ключом сервиса и отправляет транзакцию на `w3b2-bridge-program`.
3.  **Верификация:** Серверный мост получает транзакцию, верифицирует, что она подписана клиентом (проверяет `PDA` аккаунт), и **расшифровывает её своим приватным ключом**.
4.  **Установка канала:** **После получения триггера из блокчейна**, серверный мост устанавливает защищённое HTTP-соединение с клиентом и передает команду в Server API.
5.  **Передача данных:** Весь обмен данными происходит по этому зашифрованному каналу, используя **быстрое симметричное шифрование (AES-256)** с помощью сессионного ключа.
6.  **Завершение:** После выполнения задачи, соединение закрывается. Вся история команд сохраняется на блокчейне для аудита, а данные остаются в безопасности.

-----

### 4\. Структура проекта

Для удобства разработки, предотвращения дублирования кода и конфликтов версий, проект будет организован как **Rust Workspace**.

```
w3b2-bridge/
├── Cargo.toml                  # Конфигурация всего воркспейса
├── w3b2-common/                # Общая библиотека
│   ├── src/
│   │   └── lib.rs              # Содержит все общие struct и enums (CommandConfig, UserAccount, ErrorCode)
│   └── Cargo.toml              # Определяет зависимости для общей библиотеки
├── w3b2-client/                # Крейт для клиентского приложения
│   ├── src/
│   │   └── main.rs
│   └── Cargo.toml              # Зависит от w3b2-common
└── w3b2-bridge-program/        # Крейт для смарт-контракта (Anchor)
    ├── src/
    │   └── lib.rs              # Код смарт-контракта
    └── Cargo.toml              # Зависит от w3b2-common
```