### **Техническая Спецификация и Протокол: W3B2 Bridge v4.0**

**Версия документа:** 1.0
**Дата:** 18 сентября 2025 г.

#### **1. Введение и Философия**

Протокол W3B2 Bridge предоставляет стандартизированный, безопасный и удобный способ интеграции традиционных Web2-сервисов с блокчейном Solana. Основная цель — обеспечить Web2-like пользовательский опыт (UX), полностью абстрагируя пользователя от сложностей управления крипто-активами в повседневных операциях, при этом сохраняя все преимущества безопасности, прозрачности и децентрализации блокчейна.

Архитектура основана на модели **"Изолированных Сервисных Кошельков" (`ChainCard`)**. Для каждого сервиса, который использует пользователь, создается отдельный, выделенный кошелек. Этот кошелек используется для всех операционных транзакций с данным сервисом, что позволяет:
* **Изолировать активы и активность:** Операции с одним сервисом не влияют на другие и не "засоряют" историю транзакций основного кошелька пользователя.
* **Повысить безопасность:** Потенциальная компрометация `ChainCard` одного сервиса не затрагивает другие активы пользователя.
* **Упростить UX:** Пользователь взаимодействует с привычным ему приложением, в то время как `w3b2-connector` управляет `ChainCard` "под капотом".

#### **2. Архитектура и Компоненты**

| Компонент                 | Тип       | Описание                                                                                                                                               |
| :------------------------ | :-------- | :----------------------------------------------------------------------------------------------------------------------------------------------------- |
| **`w3b2-bridge-program`** | On-Chain  | Смарт-контракт на базе Anchor, реализующий основную логику протокола.                                                                                  |
| **`w3b2-connector`**      | Off-Chain | Клиентское/серверное приложение, которое управляет кошельками, слушает события и взаимодействует со смарт-контрактом.                                  |
| **`ChainCard`**           | Off-Chain | Стандартный кошелек Solana (`Keypair`), создаваемый и управляемый `w3b2-connector`. Является **единственным подписантом** всех транзакций в протоколе. |
| **`AdminProfile` PDA**    | On-Chain  | Профиль сервиса (Админа), хранящий его конфигурацию и прайс-лист.                                                                                      |
| **`UserProfile` PDA**     | On-Chain  | Профиль пользователя, связывающий его `ChainCard` с конкретным `AdminProfile` и хранящий его депозитный баланс.                                        |

#### **3. On-Chain Структуры Данных (`state.rs`)**

* **`AdminProfile`**
    * `authority`: `Pubkey` — Публичный ключ **`Admin ChainCard`**. Единственный ключ, авторизованный для управления этим профилем.
    * `communication_pubkey`: `Pubkey` — Публичный ключ для гибридного шифрования off-chain сообщений.
    * `prices`: `Vec<(u64, u64)>` — Прайс-лист на платные API в формате `(command_id, price_in_lamports)`. **Это поле является динамическим и может изменять свой размер.**
    * `balance`: `u64` — Внутренний баланс PDA, куда поступают средства от платных API.

* **`UserProfile`**
    * `authority`: `Pubkey` — Публичный ключ **`User ChainCard`**. Единственный ключ, авторизованный для управления этим профилем.
    * `deposit_balance`: `u64` — Депозитный баланс пользователя для оплаты услуг админа, к которому привязан этот профиль.

#### **4. Спецификация Инструкций Смарт-Контракта**

Все инструкции, изменяющие состояние, требуют подписи от соответствующей `ChainCard`, указанной в поле `authority` целевого PDA. **Все операции, которые уменьшают баланс PDA (`withdraw`, `close_profile`), должны гарантировать, что оставшийся баланс не будет ниже минимума, необходимого для аренды (rent-exempt minimum).**

| Инструкция                | Подписант                | Аргументы               | Описание и Логика                                                                                                                                                                                              |
| :------------------------ | :----------------------- | :---------------------- | :------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **`register_admin`**      | `Admin ChainCard`        | `comm_key`, `prices`    | Создает `AdminProfile` PDA с начальным местом под 10-20 цен. **`seeds`**: `[b"admin", authority.key()]`. `authority` устанавливается в Pubkey подписанта.                                                      |
| **`update_admin_prices`** | `Admin ChainCard`        | `new_prices`            | Находит `AdminProfile` по `seeds` и обновляет поле `prices`. **Аккаунт автоматически изменяет размер (realloc)**, чтобы соответствовать новому прайс-листу.                                                    |
| **`admin_withdraw`**      | `Admin ChainCard`        | `amount`, `destination` | **Переводит `amount` с внутреннего `AdminProfile.balance` на `AdminProfile PDA`**, а затем **переводит `amount` лампортов с `AdminProfile PDA` на `destination` кошелек**.                                     |
| **`close_admin_profile`** | `Admin ChainCard`        | -                       | **Сначала выполняет `admin_withdraw` на всю сумму `balance`**, а затем **закрывает `AdminProfile` PDA**, возвращая rent на `Admin ChainCard`.                                                                  |
| **`create_user_profile`** | `User ChainCard`         | `target_admin`          | Создает `UserProfile` PDA, привязанный к конкретному админу. **`seeds`**: `[b"user", authority.key(), target_admin.key()]`. `authority` устанавливается в Pubkey подписанта.                                   |
| **`deposit`**             | `User ChainCard`         | `amount`                | Переводит `amount` лампортов с `User ChainCard` в `UserProfile` PDA, пополняя `deposit_balance`.                                                                                                               |
| **`withdraw`**            | `User ChainCard`         | `amount`, `destination` | Переводит `amount` с `UserProfile.deposit_balance` на указанный `destination` кошелек, **уменьшая баланс `UserProfile PDA`**.                                                                                  |
| **`close_profile`**       | `User ChainCard`         | -                       | Выполняет `withdraw` на весь остаток `deposit_balance` на `User ChainCard`, а затем **закрывает `UserProfile` PDA**, возвращая rent на `User ChainCard`.                                                       |
| **`dispatch_command`**    | `User ChainCard`         | `command_id`, ...       | Главная операционная команда. Находит `UserProfile` и `AdminProfile`. Проверяет `authority`. Если `price > 0`, списывает его с `deposit_balance` и зачисляет на `AdminProfile.balance`. Эмитит `CommandEvent`. |
| **`log_action`**          | `ChainCard` (User/Admin) | `session_id`, ...       | Находит соответствующий PDA (`UserProfile` или `AdminProfile`), проверяет, что подписант является его `authority`, и эмитит `HttpActionEvent`.                                                                 |

#### **5. Матрица Ответственности**

| Задача                       | `w3b2-bridge-program` (On-Chain)                                                    | `w3b2-connector` (Off-Chain)                                       |
| :--------------------------- | :---------------------------------------------------------------------------------- | :----------------------------------------------------------------- |
| **Управление `Keypair`**     | ❌ Не имеет доступа к приватным ключам.                                              | ✅ **Создает, хранит и управляет приватными ключами `ChainCard`**.  |
| **Проверка Авторизации**     | ✅ **Проверяет подпись транзакции** и сравнивает `signer.key()` с `authority` в PDA. | ✅ Формирует и подписывает транзакции с правильной `ChainCard`.     |
| **Бизнес-логика Оплаты**     | ✅ **Списывает `price`** с `deposit_balance` согласно `prices`.                      | ✅ Знает прайс-лист и решает, какую `command_id` отправить.         |
| **Off-chain Взаимодействие** | ❌ Не участвует.                                                                     | ✅ **Реализует** шифрование, HTTP-соединения и обработку `payload`. |
| **Источник Правды**          | ✅ **Является источником правды** для балансов, цен и авторизованных ключей.         | ✅ **Реагирует** на события из блокчейна и кэширует состояние.      |

----
### Как теперь работает оплата и "одобрение"?

Вместо сложной двухсторонней процедуры "запросил -> одобрил" теперь действует простая и понятная **модель "прямого депозита"**, как в любом Web2-сервисе.

Вот как это работает шаг за шагом:

**Сценарий: Пользователь хочет купить 1000 вызовов платного API у "Netflix".**

1.  **Пополнение баланса (замена `request`/`approve`):**
    * Пользователь в интерфейсе вашего приложения (`w3b2-connector`) видит кнопку "Пополнить баланс на 0.5 SOL".
    * При нажатии, `w3b2-connector` формирует и отправляет транзакцию с **одной** простой инструкцией: `deposit(amount: 0.5 SOL)`.
    * Эту транзакцию подписывает **`User ChainCard`**.
    * **Что делает смарт-контракт?** Он просто переводит 0.5 SOL с кошелька `User ChainCard` на `UserProfile` PDA, увеличивая поле `deposit_balance` на эту сумму.

    **Все!** Процесс пополнения завершен. Админ в этом никак не участвует. Это полностью **self-service** модель. Пользователь сам решает, когда и на сколько пополнить свой депозитный счет для конкретного сервиса.

2.  **Использование платного API (расчет баланса):**
    * Пользователь хочет вызвать платную команду, например, `command_id = 5` ("Стримить видео в 4K"), которая, согласно прайс-листу админа, стоит `1000` лампортов.
    * `w3b2-connector` формирует транзакцию `dispatch_command(command_id: 5, ...)`.
    * Эту транзакцию подписывает **`User ChainCard`**.
    * **Что делает смарт-контракт?**
        1.  Находит `AdminProfile` и видит в его `prices`, что команда `5` стоит `1000`.
        2.  Находит `UserProfile` пользователя и проверяет: `deposit_balance >= 1000`?
        3.  Если да, он выполняет **две операции**:
            * `user_profile.deposit_balance -= 1000` (списывает с депозита пользователя).
            * `admin_profile.balance += 1000` (зачисляет на внутренний баланс админа).
        4.  Эмитит событие `CommandEvent`.

