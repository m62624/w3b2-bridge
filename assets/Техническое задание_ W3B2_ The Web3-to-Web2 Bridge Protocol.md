### **W3B2: The Web3-to-Web2 Bridge Protocol**

**W3B2: Протокол, который обеспечивает безопасность и верификацию Web3 с гибкостью и производительностью Web2.**

Ключевая особенность: Сервис-брокер полностью изолирован от публичного интернета. Он активирует сетевой доступ к конкретному клиенту только на основе команды из блокчейна, что делает его неуязвимым для внешних атак.

---

### 1. Компоненты системы

* **Solana Program (Смарт-контракт): `w3b2-bridge-program`**
    Брокер и валидатор сообщений. Его задача — принимать команды от клиентов, проверять их подлинность и регистрировать намерения. Не хранит большие данные, выступает как доверенный координатор.

* **Service (Сервис):**
    Состоит из двух независимых крейтов:
    * `w3b2-data-server`: Отвечает за логику работы с данными (например, с базой данных PostgreSQL). Не имеет доступа к сети.
    * `w3b2-bridge-listener`: Постоянно слушает блокчейн на наличие новых команд, расшифровывает их и передает в `w3b2-data-server`, а также управляет сетевыми соединениями.

* **Client (Клиент): `w3b2-client`**
    Программа пользователя. Отправляет зашифрованные команды в блокчейн и устанавливает HTTP-соединение с сервисом для передачи данных.

---

### 2. API Программы Solana (Инструкции)

Каждая инструкция имеет две версии, каждая из которых представлена уникальным `u64`-идентификатором.

| Название               | Req-Res | One-Way | Входящие данные                                                  | Описание                                                                               |
| ---------------------- | ------- | ------- | ---------------------------------------------------------------- | -------------------------------------------------------------------------------------- |
| `RegisterUser`         | `1`     | `2`     | `pub_client`: публичный ключ клиента                             | Регистрирует пользователя. Сервис отвечает своим `pub_service` для шифрования.         |
| `RequestConnection`    | `3`     | `4`     | `config`: зашифрованный `IP` и `порт` клиента                    | Клиент запрашивает открытие сетевого соединения.                                       |
| `CRUD_Create`          | `5`     | `6`     | `config`: зашифрованный `IP` и `порт`, `data_hash`, `time_limit` | Создаёт новую запись. Сервис ожидает данные по HTTP в течение `time_limit` (таймера).  |
| `CRUD_Read`            | `7`     | `8`     | `config`: зашифрованный `IP` и `порт`, `data_id`                 | Читает данные. Сервис открывает соединение для передачи данных клиенту.                |
| `CRUD_Update`          | `9`     | `10`    | `config`: зашифрованный `IP` и `порт`, `data_id`, `time_limit`   | Обновляет существующую запись. Сервис ждёт обновления данных по HTTP.                  |
| `CRUD_Delete`          | `11`    | `12`    | `config`: зашифрованный `IP` и `порт`, `data_id`                 | Удаляет данные.                                                                        |
| `StartSession`         | `13`    | `14`    | `config`: зашифрованный `IP` и `порт`                            | Устанавливает соединение для нескольких команд (для чтения или изменения).             |
| `EndSession`           | `15`    | `16`    |                                                                  | Закрывает открытую сессию.                                                             |
| `Admin_Authorize`      | `17`    | `18`    | `admin_pub_key`: публичный ключ администратора                   | Регистрирует ключ администратора для привилегированных операций.                       |
| `Admin_Access_Control` | `19`    | `20`    | `config`: зашифрованный `admin_action`, `user_id`                | Предоставляет администратору доступ к данным.                                          |
| `Generic_Command`      | `21`    | `22`    | `config`: зашифрованные произвольные данные                      | Универсальная команда, которая может быть использована для любых расширений протокола. |

---

### 3. Процесс Работы

1.  **Регистрация:** Клиент генерирует ключи, отправляет свой публичный ключ в блокчейн. Сервис отвечает своим публичным ключом.
2.  **Запрос:** Клиент шифрует конфигурацию (включая IP, порт, и **сессионный ключ**) публичным ключом сервиса и отправляет транзакцию на `w3b2-bridge-program`.
3.  **Верификация:** `w3b2-bridge-listener` получает транзакцию, верифицирует, что она подписана клиентом, и расшифровывает её.
4.  **Установка канала:** На основе расшифрованных данных, `w3b2-bridge-listener` устанавливает защищённое HTTP-соединение с клиентом и передает команду в `w3b2-data-server`.
5.  **Передача данных:** Весь обмен данными происходит по этому зашифрованному каналу, используя **быстрое симметричное шифрование (AES-256)** с помощью сессионного ключа.
6.  **Завершение:** После выполнения задачи, соединение закрывается. Вся история команд сохраняется на блокчейне для аудита, а данные остаются в безопасности.