# PROTOCOL W3B2

Протокол W3B2 основан на асинхронной, событийно-ориентированной архитектуре, где блокчейн Solana служит единственным доверенным каналом коммуникации. Web2-сервис и пользователи взаимодействуют друг с другом исключительно через транзакции и события, фиксируемые на блокчейне. Это обеспечивает:
* работу Web2-сервиса в изолированной среде, где единственным источником команд является блокчейн;
* верификацию каждого действия пользователя на блокчейне;
* безопасную передачу данных благодаря гибридному шифрованию;
* создание сервисов, использующих внешние API, без риска прямых кибератак;
* полную прозрачность и неизменяемую историю взаимодействия.

---

### Как происходит взаимодействие

Протокол W3B2 позволяет традиционным Web2-сервисам использовать блокчейн Solana как защищенную и прозрачную коммуникационную шину, при этом для конечного пользователя взаимодействие выглядит как обычное API-взаимодействие. Пользователям не нужно иметь дело с криптокошельками или понимать специфику блокчейна — все сложности скрыты.

Процесс взаимодействия выглядит следующим образом:
1.  **Создание и распространение Администратора.** Компания регистрирует свой аккаунт (**Admin Account**) на блокчейне. Этот аккаунт служит "лицом" компании и содержит средства для оплаты транзакционных комиссий. Публичный ключ этого аккаунта распространяется среди пользователей, которые используют его как адрес для своих запросов.
2.  **Запрос средств (Funding).** Когда пользователь хочет оплатить услугу (например, API-запрос), он отправляет на блокчейн команду `request_funding`. Эта команда содержит запрос на перевод определенной суммы с **Admin Account** на аккаунт пользователя.
3.  **Одобрение Администратором.** Сервис (Admin) постоянно мониторит блокчейн. Когда запрос обнаружен, сервис отправляет транзакцию `approve_funding`, которая переводит средства с администраторского счета на счет пользователя.
4.  **Выполнение команды (Dispatch).** После получения средств пользователь может отправить команду `dispatch_command`. Она может содержать как зашифрованные, так и обычные данные. Если это зашифрованные данные, они содержат временный сессионный ключ для установления защищенного HTTP-соединения между сервисом и пользователем. Это позволяет безопасно передавать более объемные данные, используя блокчейн только для инициации и аутентификации.

---

### Событийно-ориентированная архитектура и синхронизация

Основная логика сервиса строится на асинхронной, событийно-ориентированной модели. Solana используется для регистрации и отправки команд, а также для хранения всех взаимодействий в виде событий, что обеспечивает полную прозрачность.

Чтобы сервис всегда был в курсе происходящего на блокчейне, даже если он временно отключится, используется два параллельно работающих "воркера":

* **Live-Sync Worker (Воркер "Живой синхронизации")**: Этот воркер подключается к блокчейну через WebSocket-соединение и получает уведомления обо всех новых событиях в реальном времени. Он обрабатывает их немедленно.
* **Catch-Up Worker (Воркер "Догоняющей синхронизации")**: Этот воркер периодически сканирует историю блокчейна, начиная с последней обработанной транзакции. Он необходим для восстановления работы после сбоев или простоев, гарантируя, что ни одна транзакция не будет потеряна.

Все события, обработанные обоими воркерами, направляются в единый канал (MPSC), который служит точкой входа для основной бизнес-логики сервиса. Состояние синхронизации (последний обработанный слот и сигнатура транзакции) сохраняется в локальной базе данных, чтобы после перезапуска воркеры знали, с какого момента начинать синхронизацию.


### Как запускать

1. **builder-only** — просто собрать и сохранить артефакты
* Только билд (артефакты наружу в `./target`):

  ```bash
  docker compose --profile builder build
  ```

2. **deploy** — поднять validator, задеплоить смарт-контракт и запустить connector

  ```bash
  docker compose --profile validator up
  ```
3. **validator** — только validator
* Деплой + connector (включает validator автоматически):

  ```bash
  docker compose --profile deploy up
  ```


4. **full** — frontend + backend + validator + deploy

  ```bash
  docker compose --profile full up
  ```
