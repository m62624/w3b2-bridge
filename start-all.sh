#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –≤—Å–µ—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ W3B2 Bridge

echo "üöÄ –ó–∞–ø—É—Å–∫ W3B2 Bridge —Å–∏—Å—Ç–µ–º—ã..."

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ—Ä—Ç–∞
check_port() {
    if lsof -Pi :$1 -sTCP:LISTEN -t >/dev/null ; then
        echo "‚ùå –ü–æ—Ä—Ç $1 —É–∂–µ –∑–∞–Ω—è—Ç"
        exit 1
    fi
}

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ—Ä—Ç—ã
echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Ä—Ç–æ–≤..."
check_port 50051  # gRPC –∫–æ–Ω–Ω–µ–∫—Ç–æ—Ä
check_port 3001   # Backend
check_port 3000   # Frontend

# –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –¥–ª—è –ª–æ–≥–æ–≤
mkdir -p logs

echo "üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –±—ç–∫–µ–Ω–¥–∞
echo "üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –±—ç–∫–µ–Ω–¥–∞..."
cd w3b2-bridge-backend
npm install
cd ..

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞
echo "üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞..."
cd w3b2-bridge-frontend
npm install
cd ..

echo "üîß –°–±–æ—Ä–∫–∞ –∫–æ–Ω–Ω–µ–∫—Ç–æ—Ä–∞..."
cd w3b2-connector
cargo build --release
cd ..

echo "üöÄ –ó–∞–ø—É—Å–∫ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤..."

# –ó–∞–ø—É—Å–∫ gRPC –∫–æ–Ω–Ω–µ–∫—Ç–æ—Ä–∞ –≤ —Ñ–æ–Ω–µ
echo "üîå –ó–∞–ø—É—Å–∫ gRPC –∫–æ–Ω–Ω–µ–∫—Ç–æ—Ä–∞..."
cd w3b2-connector
cargo run > ../logs/connector.log 2>&1 &
CONNECTOR_PID=$!
cd ..

# –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞ –∫–æ–Ω–Ω–µ–∫—Ç–æ—Ä–∞
sleep 5

# –ó–∞–ø—É—Å–∫ –±—ç–∫–µ–Ω–¥–∞ –≤ —Ñ–æ–Ω–µ
echo "üñ•Ô∏è –ó–∞–ø—É—Å–∫ –±—ç–∫–µ–Ω–¥–∞..."
cd w3b2-bridge-backend
npm run dev > ../logs/backend.log 2>&1 &
BACKEND_PID=$!
cd ..

# –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞ –±—ç–∫–µ–Ω–¥–∞
sleep 5

# –ó–∞–ø—É—Å–∫ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞ –≤ —Ñ–æ–Ω–µ
echo "üåê –ó–∞–ø—É—Å–∫ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞..."
cd w3b2-bridge-frontend
npm start > ../logs/frontend.log 2>&1 &
FRONTEND_PID=$!
cd ..

echo "‚úÖ –í—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –∑–∞–ø—É—â–µ–Ω—ã!"
echo ""
echo "üìä –°—Ç–∞—Ç—É—Å –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤:"
echo "  üîå gRPC –∫–æ–Ω–Ω–µ–∫—Ç–æ—Ä: PID $CONNECTOR_PID (–ø–æ—Ä—Ç 50051)"
echo "  üñ•Ô∏è Backend: PID $BACKEND_PID (–ø–æ—Ä—Ç 3001)"
echo "  üåê Frontend: PID $FRONTEND_PID (–ø–æ—Ä—Ç 3000)"
echo ""
echo "üìù –õ–æ–≥–∏:"
echo "  üìÑ –ö–æ–Ω–Ω–µ–∫—Ç–æ—Ä: logs/connector.log"
echo "  üìÑ –ë—ç–∫–µ–Ω–¥: logs/backend.log"
echo "  üìÑ –§—Ä–æ–Ω—Ç–µ–Ω–¥: logs/frontend.log"
echo ""
echo "üåê –û—Ç–∫—Ä–æ–π—Ç–µ http://localhost:3000 –≤ –±—Ä–∞—É–∑–µ—Ä–µ"
echo ""
echo "üõë –î–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –Ω–∞–∂–º–∏—Ç–µ Ctrl+C"

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –≤—Å–µ—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤
cleanup() {
    echo ""
    echo "üõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤—Å–µ—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤..."
    kill $CONNECTOR_PID 2>/dev/null
    kill $BACKEND_PID 2>/dev/null
    kill $FRONTEND_PID 2>/dev/null
    echo "‚úÖ –í—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"
    exit 0
}

# –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–∏–≥–Ω–∞–ª–æ–≤
trap cleanup SIGINT SIGTERM

# –ñ–¥–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
wait
