# W3B2 Connector

Rust сервис для синхронизации с блокчейном Solana и предоставления gRPC API для передачи событий.

## Описание

Коннектор обеспечивает надежную синхронизацию с блокчейном Solana через два параллельно работающих воркера и предоставляет gRPC API для передачи событий в реальном времени.

## Архитектура

### Двойная синхронизация

1. **Live-Sync Worker** - подключается к блокчейну через WebSocket и получает события в реальном времени
2. **Catch-Up Worker** - периодически сканирует историю блокчейна для восстановления после сбоев

### Поток данных

```
[Solana Blockchain] 
    ↓ (WebSocket/RPC)
[Live-Sync Worker] ──┐
                    ├── [MPSC Channel] ── [gRPC Server]
[Catch-Up Worker] ──┘
```

## Основные функции

### Синхронизация
- **Real-time события** через WebSocket подключение
- **Исторические данные** через RPC для восстановления
- **Надежность** - гарантирует обработку всех транзакций
- **Персистентность** - сохраняет состояние в локальной БД

### gRPC API
- **Stream Events** - стриминг событий в реальном времени
- **Автоматическое переподключение** при сбоях
- **Масштабируемость** - поддержка множественных клиентов

## Конфигурация

### config.toml
```toml
rpc_url = "http://127.0.0.1:8899"
ws_url = "ws://127.0.0.1:8900"
max_catchup_depth = 1000
max_request_age_minutes = 60
poll_interval_secs = 3
data_dir = "./w3b2_db"
log_dir = "Logs"
host = "[::1]"
port = 50051
```

## Запуск

```bash
# Сборка
cargo build --release

# Запуск
cargo run

# Запуск с конфигурацией
cargo run -- --config config.toml
```

## Мониторинг

### Логи
- События синхронизации
- Ошибки подключения
- Статистика обработки

### Метрики
- Количество обработанных событий
- Время синхронизации
- Статус подключений

## Структура проекта

```
src/
├── main.rs           # Точка входа и gRPC сервер
├── lib.rs            # Основная библиотека
├── synchronizer.rs   # Координация воркеров
├── live.rs           # Live-Sync воркер
├── catchup.rs        # Catch-Up воркер
├── storage.rs        # Локальное хранилище
├── config.rs         # Конфигурация
└── events.rs         # Обработка событий
```

## Интеграция

Коннектор интегрируется с:
- **Backend** - через gRPC клиент
- **Solana RPC** - для получения данных
- **Solana WebSocket** - для real-time событий
- **Локальная БД** - для хранения состояния

## Отладка

```bash
# Проверка подключения к Solana
curl http://localhost:8899

# Проверка gRPC сервера
grpcurl -plaintext localhost:50051 list

# Просмотр логов
tail -f w3b2_db/Logs/w3b2-*.log
```
